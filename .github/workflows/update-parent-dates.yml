name: Auto-Update Parent Issue Dates from Iterations

on:
  issues:
    types: [opened, edited, closed, reopened, milestoned, demilestoned]
  schedule:
    - cron: "0 0 * * *"  # Runs daily
  workflow_dispatch:  # Allows manual runs

jobs:
  update-parent-dates:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Get Parent Issue Number
        id: get_parent
        run: |
          PARENT=$(gh issue list --search "is:open linked:${{ github.event.issue.number }}" --json number --jq ".[0].number")
          echo "PARENT_ISSUE=$PARENT" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Iteration Dates from Child Issues
        id: get_iteration_dates
        run: |
          if [ -z "$PARENT_ISSUE" ]; then
            echo "No parent issue found. Exiting."
            exit 0
          fi

          DATES=$(gh issue list --search "is:open linked:$PARENT_ISSUE" --json number,fields --jq '[.[] | {iteration: .fields.iteration}]')

          EARLIEST_ITERATION=$(echo $DATES | jq -r 'map(.iteration.startDate) | min')
          LATEST_ITERATION=$(echo $DATES | jq -r 'map(.iteration.endDate) | max')

          echo "EARLIEST_ITERATION=$EARLIEST_ITERATION" >> $GITHUB_ENV
          echo "LATEST_ITERATION=$LATEST_ITERATION" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Parent Issue with Aggregated Iteration Dates
        if: env.PARENT_ISSUE != ''
        run: |
          gh issue edit $PARENT_ISSUE --body "**Start Iteration:** $EARLIEST_ITERATION\n**End Iteration:** $LATEST_ITERATION"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
